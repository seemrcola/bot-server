<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bot Server 对话测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
      .scrollbar-thin::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 9999px; }
      .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
      .prose pre { white-space: pre-wrap; }
    </style>
  </head>
  <body class="min-h-screen bg-slate-50">
    <div class="max-w-6xl mx-auto p-6">
      <header class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-full bg-white ring-1 ring-slate-300 text-slate-900 grid place-items-center text-sm font-semibold">AI</div>
          <h1 class="text-lg font-medium text-slate-900 tracking-tight">Bot Server 对话测试</h1>
          <span id="statePill" class="ml-2 inline-flex items-center rounded-full border border-slate-200 bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-700">空闲</span>
        </div>
        <div class="flex items-center gap-4">
          <button id="clearBtn" class="px-3 py-1.5 text-xs rounded-md border border-slate-200 text-slate-700 hover:bg-slate-100">清空对话</button>
          <div class="flex items-center gap-2">
            <label class="text-xs text-slate-500">Base URL</label>
            <input id="baseUrl" class="px-3 py-2 rounded-lg bg-white border border-slate-300 text-slate-700 text-sm w-[280px] focus:outline-none focus:ring-2 focus:ring-slate-200" value="http://localhost:3000" />
          </div>
        </div>
      </header>

      <main class="grid grid-cols-12 gap-6">
        <!-- Chat Column -->
        <section class="col-span-12 lg:col-span-8 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between bg-slate-50/60">
            <div>
              <div class="text-sm font-medium text-slate-900 tracking-tight">对话</div>
              <div class="text-xs text-slate-500">支持多轮对话 / 工具调用</div>
            </div>
            <div class="flex items-center gap-2">
              <button data-preset="hello" class="preset-btn px-2.5 py-1.5 text-xs rounded-md border border-slate-200 text-slate-700 hover:bg-slate-100">普通对话</button>
              <button data-preset="tool" class="preset-btn px-2.5 py-1.5 text-xs rounded-md border border-slate-200 text-slate-700 hover:bg-slate-100">工具调用</button>
              <button data-preset="context" class="preset-btn px-2.5 py-1.5 text-xs rounded-md border border-slate-200 text-slate-700 hover:bg-slate-100">上下文测试</button>
            </div>
          </div>

          <div id="chatList" class="h-[50vh] overflow-y-auto p-4 space-y-4 scrollbar-thin bg-white">
            <!-- messages will appear here -->
          </div>

          <div class="border-t border-slate-100 p-4">
            

            <div class="flex items-end gap-2">
              <textarea id="userInput" class="flex-1 px-3 py-2 rounded-lg bg-white border border-slate-300 text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" rows="2" placeholder="输入你的问题..."></textarea>
              <button id="sendBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">发送</button>
            </div>
            <div class="mt-2 text-xs text-slate-500">提示：支持多轮对话，可以说"再查一次"、"重新查询"等上下文指令</div>
          </div>
        </section>

        <!-- ReAct Steps Column -->
        <aside class="col-span-12 lg:col-span-4 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
          <div class="px-4 pt-3 border-b border-slate-100 bg-slate-50/60">
            <div class="flex items-center">
              <button id="tabSteps" class="px-3 py-2 text-xs rounded-t-md border border-b-0 border-slate-200 bg-white text-slate-900">ReAct 步骤</button>
              <button id="tabMeta" class="ml-2 px-3 py-2 text-xs rounded-t-md border border-slate-200 bg-transparent text-slate-600">Agents / Tools</button>
              <div class="flex-1"></div>
            </div>
          </div>
          <div id="panelSteps" class="h-[60vh] overflow-y-auto overflow-x-hidden p-4 space-y-2 text-xs font-mono text-slate-800 bg-white scrollbar-thin break-words"></div>
          <div id="panelMeta" class="hidden h-[60vh] overflow-y-auto overflow-x-hidden p-4 space-y-2 text-xs font-mono text-slate-800 bg-white scrollbar-thin break-words">
            <div class="mb-2 flex items-center gap-2">
              <button id="btnListAgents" class="px-2.5 py-1.5 text-xs rounded-md border border-slate-200 text-slate-700 hover:bg-slate-100">查看 Agents</button>
              <button id="btnListTools" class="px-2.5 py-1.5 text-xs rounded-md border border-slate-200 text-slate-700 hover:bg-slate-100">查看 Tools</button>
            </div>
            <div id="metaContent" class="space-y-2"></div>
          </div>
        </aside>
      </main>
    </div>

    <template id="tpl-user">
      <div class="flex items-start gap-3 ml-auto flex-row-reverse">
        <div class="shrink-0 h-8 w-8 rounded-full bg-slate-200 grid place-items-center text-slate-600">你</div>
        <div class="rounded-2xl px-4 py-2 max-w-[80%] bg-slate-900 text-white"></div>
      </div>
    </template>
    <template id="tpl-ai">
      <div class="flex items-start gap-3">
        <div class="shrink-0 h-8 w-8 rounded-full bg-white ring-1 ring-slate-300 grid place-items-center text-slate-900">AI</div>
        <div class="bg-white border border-slate-200 rounded-2xl px-4 py-2 max-w-[80%] text-slate-900"></div>
      </div>
    </template>

    <script>
      const $ = (id) => document.getElementById(id)
      const baseUrl = $('baseUrl')
      const chatList = $('chatList')
      const panelSteps = $('panelSteps')
      const panelMeta = $('panelMeta')
      const userInput = $('userInput')
      const sendBtn = $('sendBtn')
      const clearBtn = $('clearBtn')
      
      const statePill = $('statePill')
      

      const tabSteps = $('tabSteps')
      const tabMeta = $('tabMeta')

      const tplUser = $('tpl-user')
      const tplAi = $('tpl-ai')

      const presets = document.querySelectorAll('.preset-btn')
      const btnListAgents = document.getElementById('btnListAgents')
      const btnListTools = document.getElementById('btnListTools')
      const metaBox = document.getElementById('metaContent')

      let cachedReactSteps = []
      let conversationHistory = [] // 维护完整对话历史

      function setState(text, color) {
        const turnCount = Math.floor(conversationHistory.length / 2) // 计算对话轮数
        const displayText = turnCount > 0 ? `${text} (第${turnCount}轮)` : text
        statePill.textContent = displayText
        statePill.className = 'ml-2 inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium '
          + (color || 'bg-indigo-50 text-indigo-700')
      }

      function appendUser(text) {
        const node = tplUser.content.firstElementChild.cloneNode(true)
        node.querySelector('div:nth-child(2)').textContent = text
        chatList.appendChild(node)
        chatList.scrollTop = chatList.scrollHeight
      }

      function appendAiContainer() {
        const node = tplAi.content.firstElementChild.cloneNode(true)
        chatList.appendChild(node)
        chatList.scrollTop = chatList.scrollHeight
        return node.querySelector('div:nth-child(2)')
      }

      function appendStepLine(jsonLine) {
        const line = document.createElement('div')
        line.textContent = jsonLine
        line.className = 'px-2 py-1 bg-white rounded border border-slate-200 whitespace-pre-wrap break-words'
        panelSteps.appendChild(line)
        panelSteps.scrollTop = panelSteps.scrollHeight
      }

      function renderMeta(title, data) {
        const box = document.createElement('div')
        box.className = 'space-y-1'
        const t = document.createElement('div')
        t.className = 'text-xs font-semibold text-slate-700'
        t.textContent = title
        const pre = document.createElement('pre')
        pre.className = 'text-[11px] whitespace-pre-wrap break-words bg-white border border-slate-200 rounded p-2'
        pre.textContent = JSON.stringify(data, null, 2)
        box.appendChild(t)
        box.appendChild(pre)
        metaBox.innerHTML = ''
        metaBox.appendChild(box)
      }

      function clearUI() {
        chatList.innerHTML = ''
        panelSteps.innerHTML = ''
        cachedReactSteps = []
        conversationHistory = [] // 清空对话历史
        setState('空闲')
      }

      async function streamChat(userMessage) {
        // 添加用户消息到历史
        conversationHistory.push({ type: 'human', content: userMessage })
        
        const url = (baseUrl.value || '').replace(/\/$/, '') + '/api/chat/stream'

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: conversationHistory, // 传入完整对话历史
            reactVerbose: true,
          })
        })

        const aiBox = appendAiContainer()
        const decoder = new TextDecoder()
        const reader = res.body?.getReader()
        if (!res.ok || !reader) {
          aiBox.textContent = `[错误] HTTP ${res.status}`
          setState('失败', 'bg-rose-50 text-rose-700')
          return { hasFinal: false }
        }

        let hasFinal = false
        let aiResponse = '' // 用于积累AI的完整回复
        needsUserInput = false

        while (true) {
          const { done, value } = await reader.read()
          if (done) break
          const chunk = decoder.decode(value)
          const lines = chunk.split('\n').filter(Boolean)
          for (const line of lines) {
            // 1) 尝试 JSON 步骤
            try {
              const step = JSON.parse(line)
              cachedReactSteps.push(step)
              appendStepLine(line)
              if (step.action === 'final_answer' && typeof step.answer === 'string') hasFinal = true
              continue
            } catch (_) {}

            // 2) 增强后的 Markdown 文本（拼接显示）
            aiResponse += line // 积累AI回复
            aiBox.textContent += line
            chatList.scrollTop = chatList.scrollHeight
          }
        }

        // 将AI回复添加到对话历史
        if (aiResponse.trim()) {
          conversationHistory.push({ type: 'ai', content: aiResponse.trim() })
        }

        return { hasFinal }
      }

      sendBtn.addEventListener('click', async () => {
        const text = (userInput.value || '').trim()
        if (!text) return
        setState('执行中')
        appendUser(text)
        const { hasFinal } = await streamChat(text) // 直接传入用户消息
        setState('完成', 'bg-emerald-50 text-emerald-700')
        userInput.value = ''
      })

      clearBtn.addEventListener('click', () => {
        if (confirm('确定要清空对话历史吗？')) {
          clearUI()
        }
      })

      

      presets.forEach(btn => {
        btn.addEventListener('click', () => {
          const t = btn.getAttribute('data-preset')
          if (t === 'hello') userInput.value = '你好，请用三句话介绍你自己'
          if (t === 'tool') userInput.value = '获取当前系统信息与北京天气，并整理成要点列表'
          if (t === 'context') userInput.value = '请先帮我查一下系统信息'
        })
      })

      btnListAgents.addEventListener('click', async () => {
        const url = (baseUrl.value || '').replace(/\/$/, '') + '/api/list/agents'
        const res = await fetch(url)
        const json = await res.json().catch(() => ({}))
        renderMeta('Agents', json)
        tabMeta.click()
      })

      btnListTools.addEventListener('click', async () => {
        const url = (baseUrl.value || '').replace(/\/$/, '') + '/api/list/tools'
        const res = await fetch(url)
        const json = await res.json().catch(() => ({}))
        renderMeta('Tools', json)
        tabMeta.click()
      })

      // Tabs
      tabSteps.addEventListener('click', () => {
        tabSteps.className = 'px-3 py-2 text-xs rounded-t-md border border-b-0 border-slate-200 bg-white text-slate-900'
        tabMeta.className = 'ml-2 px-3 py-2 text-xs rounded-t-md border border-slate-200 bg-transparent text-slate-600'
        panelSteps.classList.remove('hidden')
        panelMeta.classList.add('hidden')
      })
      tabMeta.addEventListener('click', () => {
        tabMeta.className = 'ml-2 px-3 py-2 text-xs rounded-t-md border border-b-0 border-slate-200 bg-white text-slate-900'
        tabSteps.className = 'px-3 py-2 text-xs rounded-t-md border border-slate-200 bg-transparent text-slate-600'
        panelMeta.classList.remove('hidden')
        panelSteps.classList.add('hidden')
      })


      // 配置持久化
      ;(() => {
        try {
          const saved = localStorage.getItem('chatbase')
          if (saved) {
            const obj = JSON.parse(saved)
            if (obj.baseUrl) baseUrl.value = obj.baseUrl
          }
        } catch {}
      })()
      function persist() {
        try { localStorage.setItem('chatbase', JSON.stringify({ baseUrl: baseUrl.value })) } catch {}
      }
      baseUrl.addEventListener('change', persist)

      // 快捷发送：Cmd/Ctrl+Enter
      userInput.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
          e.preventDefault()
          sendBtn.click()
        }
      })
    </script>
  </body>
  </html>


